(function () {
    const state = {
        library: [],
        wanted: []
    };

    const sections = {
        'discover-books': document.getElementById('section-discover-books'),
        'discover-author': document.getElementById('section-discover-author'),
        'discover-isbn': document.getElementById('section-discover-isbn'),
        library: document.getElementById('section-library'),
        wanted: document.getElementById('section-wanted'),
        'hardcover-wanted': document.getElementById('section-hardcover-wanted'),
        calibre: document.getElementById('section-calibre')
    };

    const navLinks = document.querySelectorAll('.nav-link[data-section]');
    const navMap = {};
    navLinks.forEach(link => {
        navMap[link.dataset.section] = link;
    });

    const refs = {
        topbarTitle: document.getElementById('topbar-title'),
        libraryStatus: document.getElementById('library-status'),
        libraryResults: document.getElementById('library-results'),
        wantedStatus: document.getElementById('wanted-status'),
        wantedResults: document.getElementById('wanted-results')
    };

    function bookKey(book) {
        return book.slug || book.id || book.title;
    }

    function buildIsbnPills(book) {
        const isbn = book.isbn13 || book.isbn10;
        if (!isbn) return '';
        return `<div class="isbn-pill-row"><span class="pill pill-isbn">ISBN: ${isbn}</span></div>`;
    }

    function createExpandableBlock(text, className, maxChars) {
        const safeText = text || (className === 'book-title' ? 'Untitled' : 'Unknown author');
        if (safeText.length <= maxChars) {
            return `<div class="${className}">${safeText}</div>`;
        }
        const shortText = `${safeText.slice(0, maxChars)}…`;
        const id = `expand-${Math.random().toString(36).slice(2, 9)}`;
        return `
            <div class="${className}">
                <span class="text-collapsed" data-target="${id}">${shortText}</span>
                <span class="text-expanded hidden" id="${id}">${safeText}</span>
                <button class="btn-text-toggle" data-target="${id}">More</button>
            </div>
        `;
    }

    function createBookCard(book, options) {
        const opts = Object.assign({ showWanted: false, showAddToLibrary: false }, options || {});
        const isbnText = book.isbn13 || book.isbn10 || '';
        const cardSpan = isbnText.length > 20 ? 2 : 1;

        const div = document.createElement('div');
        div.className = 'book-card';
        div.style.setProperty('--book-card-span', cardSpan);

        const title = book.title || 'Untitled';
        const authorNames = (() => {
            if (Array.isArray(book.author_names) && book.author_names.length) return book.author_names;
            if (Array.isArray(book.authors) && book.authors.length) return book.authors;
            if (book.author) return [book.author];
            if (Array.isArray(book.cached_contributors) && book.cached_contributors.length) {
                return [book.cached_contributors[0].name].filter(Boolean);
            }
            return [];
        })();

        let coverUrl =
            (book.image && book.image.url) ||
            book.coverUrl ||
            (book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg` : null);
        if (!coverUrl && Array.isArray(book.cached_contributors) && book.cached_contributors.length) {
            const contributorImage = book.cached_contributors[0].image;
            if (contributorImage && contributorImage.url) {
                coverUrl = contributorImage.url;
            }
        }

        const ratingRaw = book.rating ?? book.ratings_average ?? book.average_rating;
        const rating = typeof ratingRaw === 'number'
            ? Math.round(ratingRaw * 10) / 10
            : (ratingRaw || 'N/A');
        const editions = book.edition_count ?? book.users_count ?? book.ratings_count ?? 0;

        let detailsUrl = null;
        if (book.source === 'openlibrary') {
            const prefer = value => Array.isArray(value) ? value[0] : value;
            let editionKey = prefer(book.cover_edition_key) || prefer(book.edition_key);
            if (editionKey) {
                detailsUrl = `https://openlibrary.org/books/${editionKey}`;
            } else if (book.slug) {
                detailsUrl = `https://openlibrary.org${book.slug}`;
            }
        } else if (book.slug || book.id) {
            detailsUrl = `https://hardcover.app/books/${book.slug || book.id}`;
        }
        const viewLink = detailsUrl
            ? `<a href="${detailsUrl}" target="_blank" class="btn btn-view">View</a>`
            : '';

        let actionMarkup = '';
        if (opts.showWanted) {
            actionMarkup += `<button class="btn btn-wanted btn-wanted-action">Wanted</button>`;
        }
        if (opts.showAddToLibrary) {
            actionMarkup += `<button class="btn btn-primary btn-addlib-action">Add to library</button>`;
        }

        const actionsHtml = [actionMarkup, viewLink].filter(Boolean).length
            ? `<div class="book-actions bottom-right">${[actionMarkup, viewLink].filter(Boolean).join('')}</div>`
            : '';

        const coverElement = coverUrl
            ? `<img class="book-cover" loading="lazy" src="${coverUrl}" alt="Cover">`
            : `<div class="book-cover book-cover--placeholder">No Image Available</div>`;

        div.innerHTML = `
            <div class="book-media">
                ${coverElement}
                <div class="book-stats">
                    <span class="pill pill-metric pill-editions">Editions: ${editions}</span>
                    <span class="pill pill-metric pill-rating">Rating: ${rating}</span>
                </div>
            </div>
            <div class="book-body">
                ${createExpandableBlock(title, 'book-title', 60)}
                ${renderAuthorLinks(authorNames)}
                ${buildIsbnPills(book)}
                ${actionsHtml}
            </div>
        `;

        const coverEl = div.querySelector('.book-cover');
        if (coverEl && coverUrl) {
            coverEl.addEventListener('click', () => openLightbox({
                coverUrl,
                title,
                slug: book.slug,
                description: book.description
            }));
        }

        const wantedBtn = div.querySelector('.btn-wanted-action');
        if (wantedBtn) {
            wantedBtn.addEventListener('click', () => addToWanted(book));
        }

        const addLibBtn = div.querySelector('.btn-addlib-action');
        if (addLibBtn) {
            addLibBtn.addEventListener('click', () => addToLibrary(book));
        }

        div.querySelectorAll('.btn-text-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                const expanded = div.querySelector(`#${targetId}`);
                const collapsed = div.querySelector(`.text-collapsed[data-target="${targetId}"]`);
                if (!expanded || !collapsed) return;
                const isHidden = expanded.classList.contains('hidden');
                if (isHidden) {
                    expanded.classList.remove('hidden');
                    collapsed.classList.add('hidden');
                    button.textContent = 'Less';
                } else {
                    expanded.classList.add('hidden');
                    collapsed.classList.remove('hidden');
                    button.textContent = 'More';
                }
            });
        });

        div.querySelectorAll('.author-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const name = link.dataset.author;
                if (!name) return;
                if (window.bookwormApp && window.bookwormApp.showSection) {
                    window.bookwormApp.showSection('discover-author');
                }
                if (window.bookwormAuthorSearch && window.bookwormAuthorSearch.search) {
                    window.bookwormAuthorSearch.search(name);
                }
            });
        });

        div.querySelectorAll('.author-more-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const extra = div.querySelector(`#${targetId}`);
                if (!extra) return;
                const isHidden = extra.classList.contains('hidden');
                if (isHidden) {
                    extra.classList.remove('hidden');
                    btn.textContent = 'Less';
                } else {
                    extra.classList.add('hidden');
                    btn.textContent = 'More';
                }
            });
        });

        return div;
    }

    const lightboxEl = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxDescription = document.getElementById('lightbox-description');
    const lightboxClose = document.querySelector('.lightbox-close');

    async function openLightbox(meta) {
        if (!lightboxEl || !lightboxImage || !lightboxCaption) return;
        lightboxImage.src = meta.coverUrl;
        lightboxCaption.textContent = meta.title || '';
        if (lightboxDescription) {
            lightboxDescription.classList.add('hidden');
            lightboxDescription.textContent = '';
            const descriptionText = await resolveDescription(meta);
            if (descriptionText) {
                lightboxDescription.textContent = descriptionText;
                lightboxDescription.classList.remove('hidden');
            }
        }
        lightboxEl.classList.remove('hidden');
    }

    function closeLightbox() {
        if (!lightboxEl) return;
        lightboxEl.classList.add('hidden');
    }

    if (lightboxEl) {
        lightboxEl.addEventListener('click', (e) => {
            if (e.target === lightboxEl) closeLightbox();
        });
    }
    if (lightboxClose) {
        lightboxClose.addEventListener('click', closeLightbox);
    }

    async function resolveDescription(meta) {
        if (meta.description) return normalizeDescription(meta.description);
        if (!meta.slug || !meta.slug.startsWith('/works/')) return '';
        try {
            const res = await fetch(`https://openlibrary.org${meta.slug}.json`);
            if (!res.ok) return '';
            const data = await res.json();
            return normalizeDescription(data.description);
        } catch {
            return '';
        }
    }

    function normalizeDescription(desc) {
        if (!desc) return '';
        if (typeof desc === 'string') return desc.trim();
        if (typeof desc === 'object' && desc.value) return String(desc.value).trim();
        return '';
    }

    function addToWanted(book) {
        const key = bookKey(book);
        if (!state.wanted.some(b => bookKey(b) === key)) {
            state.wanted.push(book);
            renderWanted();
            refs.wantedStatus.textContent = 'Book added to Wanted.';
        } else {
            refs.wantedStatus.textContent = 'Already in Wanted.';
        }
    }

    function addToLibrary(book) {
        const key = bookKey(book);
        if (!state.library.some(b => bookKey(b) === key)) {
            state.library.push(book);
            renderLibrary();
            refs.libraryStatus.textContent = 'Book added to your library.';
        } else {
            refs.libraryStatus.textContent = 'Already in your library.';
        }

        const idx = state.wanted.findIndex(b => bookKey(b) === key);
        if (idx !== -1) {
            state.wanted.splice(idx, 1);
            renderWanted();
        }
    }

    function renderLibrary() {
        const { libraryStatus, libraryResults } = refs;
        libraryResults.innerHTML = '';
        if (!state.library.length) {
            libraryStatus.textContent = 'No books in your library yet.';
            return;
        }

        libraryStatus.textContent = `You have ${state.library.length} book(s) in your library.`;
        state.library.forEach(book => {
            libraryResults.appendChild(createBookCard(book, { showWanted: false, showAddToLibrary: false }));
        });
    }

    function renderWanted() {
        const { wantedStatus, wantedResults } = refs;
        wantedResults.innerHTML = '';
        if (!state.wanted.length) {
            wantedStatus.textContent = 'No wanted books yet.';
            return;
        }

        wantedStatus.textContent = `You have ${state.wanted.length} wanted book(s).`;
        state.wanted.forEach(book => {
            wantedResults.appendChild(createBookCard(book, { showWanted: false, showAddToLibrary: true }));
        });
    }

    const searchModeBySection = {
        'discover-books': 'title',
        'discover-author': 'author',
        'discover-isbn': 'isbn'
    };

    function showSection(sectionName) {
        navLinks.forEach(link => link.classList.remove('active'));
        if (navMap[sectionName]) {
            navMap[sectionName].classList.add('active');
        }

        Object.entries(sections).forEach(([name, el]) => {
            if (!el) return;
            el.classList.toggle('hidden', name !== sectionName);
        });

        if (searchModeBySection[sectionName]) {
            refs.topbarTitle.textContent = 'Search';
            const mode = searchModeBySection[sectionName];
            if (mode === 'author') {
                window.bookwormAuthorSearch && window.bookwormAuthorSearch.restore();
            } else {
                window.bookwormBookSearch && window.bookwormBookSearch.restore(mode);
            }
        } else if (sectionName === 'library') {
            refs.topbarTitle.textContent = 'Library';
        } else if (sectionName === 'wanted') {
            refs.topbarTitle.textContent = 'Wanted';
        } else if (sectionName === 'hardcover-wanted') {
            refs.topbarTitle.textContent = 'Hardcover.app · Want to read';
            window.bookwormHardcover && window.bookwormHardcover.ensureLoaded();
        } else if (sectionName === 'calibre') {
            refs.topbarTitle.textContent = 'Calibre';
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            const sectionName = link.getAttribute('data-section');
            showSection(sectionName);
        });
    });

    showSection('library');

    window.bookwormApp = {
        state,
        createBookCard,
        addToLibrary,
        addToWanted,
        renderLibrary,
        renderWanted,
        showSection
    };
})();
    function renderAuthorLinks(names) {
        if (!names.length) {
            return `<div class="book-author">Unknown author</div>`;
        }
        const maxPreview = 4;
        const preview = names.slice(0, maxPreview);
        const hasMore = names.length > maxPreview;

        const renderChip = (name, idx, includeSep = true) => {
            const safeAttr = name.replace(/"/g, '&quot;');
            const sep = includeSep && idx < preview.length - 1 ? '<span class="author-sep">, </span>' : '';
            return `<span class="author-chip"><button class="author-link" data-author="${safeAttr}">${name}</button>${sep}</span>`;
        };

        let html = preview.map((name, idx) => renderChip(name, idx)).join('');

        if (hasMore) {
            const hiddenList = names.slice(maxPreview).map((name, idx) => renderChip(name, idx, idx < names.length - maxPreview - 1)).join('');
            const listId = `author-extra-${Math.random().toString(36).slice(2, 9)}`;
            html += `
                <span class="author-more">
                    <button class="btn-text-toggle author-more-btn" data-target="${listId}">More</button>
                </span>
                <span id="${listId}" class="author-extra hidden">
                    ${hiddenList}
                </span>
            `;
        }

        return `<div class="book-author-links">${html}</div>`;
    }
